# M-Language 项目 MCP + Skills 完整方案（基于当前代码与已接硬件）

## 1. 现状基线（你现在已有）

### 1.1 硬件资源
- 控制器：NodeMCU (ESP8266)
- 传感器：
  - 水位传感器（device_id=1, A0）
  - DHT11 温度（device_id=2, D4）
  - DHT11 湿度（device_id=3, D4）
- 执行器：
  - Relay_1（device_id=5, D1）
  - Relay_2（device_id=6, D2）

### 1.2 软件链路
- 本地 Ollama（已可用，qwen3:8b / 其他模型）
- Tool Router（OpenAI 兼容接口）
- MCP Server（Streamable HTTP, 9001/mcp）
- Open WebUI（通过 Tool Router 调 MCP）

### 1.3 当前 MCP 工具能力（已实现）
- `get_hardware_topology_mcp`
- `read_water_level_mcp`
- `execute_m_logic_mcp`
- `check_serial_config_mcp`
- `detect_and_connect_mcp`
- `read_vm_state_mcp`

结论：
- 你已经具备“基础可用”的工具层。
- 当前主要是“单工具调用”，缺的是“多步业务编排（skills）”和“安全策略层”。

---

## 2. 目标：从 MCP 工具层升级到 MCP + Skills 业务层

## 2.1 分层设计
- L0 设备层：ESP8266 + 传感器 + 继电器
- L1 协议层：M-Token + 串口通信（`core.py`）
- L2 工具层（MCP）：提供可调用原子能力
- L3 技能层（Skills）：把多个工具组合成业务流程
- L4 对话层：WebUI + Router + 本地模型

核心原则：
- MCP 负责“原子能力 + 边界校验”。
- Skills 负责“流程编排 + 条件判断 + 重试 + 输出结论”。
- 模型不要直接控制底层字节码细节，优先通过语义化 skill 调用。

---

## 3. 建议的 Skills 体系（第一版）

## 3.1 设备自检 Skill（强烈建议优先）
目标：一条指令完成“能不能工作”的整体验证。

流程：
1. 检查串口配置（`check_serial_config_mcp`）
2. 自动检测串口（`detect_and_connect_mcp`）
3. 读取硬件拓扑（`get_hardware_topology_mcp`）
4. 快速采样：水位/温度/湿度各 1 次
5. 生成“可用/降级/不可用”状态

输出：
- health_status: `ok | degraded | failed`
- missing_devices
- serial_info
- 建议动作（如“请切换 COM 口”）

价值：上线前和故障时都能快速定位，不再靠人工猜。

## 3.2 环境快照 Skill
目标：一次拿到“水位 + 温度 + 湿度 + 继电器状态（如可读）”的统一结构化快照。

流程：
1. 连续读取传感器（建议 3 次）
2. 简单滤波（去极值或均值）
3. 标准化输出（单位、时间戳、置信度）

输出：
- water_level_raw
- temperature_c
- humidity_pct
- quality_flag（是否异常抖动）

价值：给后续告警/控制策略提供稳定输入。

## 3.3 阈值告警 Skill
目标：把传感器数据转成业务事件（过高/过低/突变）。

流程：
1. 读取环境快照
2. 应用阈值策略（可配置）
3. 输出告警级别与建议动作

建议告警级别：
- INFO：正常波动
- WARN：接近阈值
- CRITICAL：越限，建议自动联动继电器

价值：从“读数值”变成“可执行判断”。

## 3.4 继电器安全控制 Skill
目标：在可控前提下执行继电器动作。

流程：
1. 先做权限和前置检查（串口/设备在线）
2. 执行继电器开关（通过受限工具，不建议直接裸 `execute_m_logic_mcp`）
3. 回读一次传感器确认动作效果（可选）
4. 记录操作日志（谁在何时触发了什么）

安全约束：
- 默认双确认（尤其是“持续开启”）
- 设置最长开启时长（auto-off）
- 连续失败后熔断（避免反复击穿）

价值：把“可控”变成“可安全控”。

## 3.5 自动灌排/联动 Skill（第二阶段）
目标：按策略自动联动继电器（例如水位低开泵，高关泵）。

流程：
1. 周期采样
2. 状态机判断（低水位/正常/高水位）
3. 控制继电器动作
4. 防抖和最小动作间隔

必须有：
- 手动紧急停止开关
- 最大运行时间保护
- 温湿度越界保护策略

价值：进入“半自动运行”阶段。

---

## 4. 对当前代码的关键改造建议（不改架构方向，只补齐能力）

## 4.1 MCP 工具层补齐“语义化工具”
当前问题：
- 只有 `read_water_level_mcp` 是语义化工具。
- 温湿度、继电器目前主要靠 `execute_m_logic_mcp` 间接完成，模型容易误拼 token。

建议新增工具（优先级高）：
- `read_temperature_mcp`
- `read_humidity_mcp`
- `relay_set_mcp(channel, state, duration_sec?)`
- `relay_all_off_mcp()`
- `read_environment_snapshot_mcp()`（一次返回水位+温湿）

原则：
- 复杂 token 序列封装在服务端，不暴露给模型。
- 模型只传语义参数（channel/state/阈值），减少误调用。

## 4.2 工具注解和风险分级
按 MCP best practices 做注解：
- 只读工具：`readOnlyHint=true`
- 写操作工具：`destructiveHint=true`
- 幂等性明确标注（如 `relay_all_off` 通常可视作幂等）

把工具分级：
- Level A：只读（拓扑、快照、状态）
- Level B：低风险写（短时继电器动作）
- Level C：高风险写（持续开启、自动模式切换）

## 4.3 Router 层策略
- 对高风险工具增加“调用门禁”字段（例如 require_confirmation）
- 增加统一 request_id，串起 chat/tool/serial 日志
- 为工具调用设置超时和重试策略（区分读写）

---

## 5. 安全与可靠性设计（必须落实）

## 5.1 安全策略
- 默认 fail-safe：异常时继电器回到安全态（建议全关）
- 最大执行时长：继电器连续开启超过阈值自动关闭
- 双重确认：高风险操作必须二次确认
- 物理优先：保留硬件侧保险（继电器默认状态、电源保护）

## 5.2 可靠性策略
- 采样防抖：传感器值采用窗口平滑
- 通信重试：串口读失败可重试 1~2 次
- 熔断机制：连续 N 次失败进入保护状态
- 启动自检：系统启动后先执行设备自检 skill

## 5.3 可观测性
必须可查：
- 每次 tool 调用（入参、耗时、结果、错误码）
- 串口错误分类（端口不可用、超时、协议错误）
- 继电器操作审计（时间、通道、操作者、原因）

---

## 6. 推荐业务场景模板（你可以直接用于 WebUI）

## 6.1 巡检场景
输入：
- “做一次设备巡检并给结论”

系统动作：
- 执行设备自检 skill -> 输出健康报告 + 风险项

## 6.2 实时监测场景
输入：
- “读取当前环境状态并判断是否异常”

系统动作：
- 执行环境快照 skill -> 执行阈值告警 skill -> 给出等级与建议

## 6.3 安全控制场景
输入：
- “把 1 路继电器打开 10 秒，然后恢复”

系统动作：
- 执行继电器安全控制 skill -> 自动回落 -> 输出执行回执

---

## 7. 实施路线图（按周）

## Phase 0（当前已完成）
- 本地 Ollama + Router + MCP 跑通
- 水位读取可用

## Phase 1（建议 1~2 天）
- 补齐语义化 MCP 工具：温度/湿度/继电器控制/环境快照
- 完成工具分级与错误码规范
- 完成设备自检 skill + 环境快照 skill

交付标准：
- WebUI 中可稳定调用四类硬件能力
- 失败时有明确可执行错误提示

## Phase 2（建议 2~4 天）
- 上线阈值告警 skill + 继电器安全控制 skill
- 增加审计日志与熔断机制

交付标准：
- 能根据阈值自动给出告警
- 高风险操作具备保护策略

## Phase 3（建议 3~7 天）
- 自动联动 skill（半自动控制）
- 状态机与策略参数化（阈值、最小动作间隔、保护时间）

交付标准：
- 在真实运行中可持续工作，不依赖人工盯盘

---

## 8. 验收指标（建议量化）

- MCP 可用性：> 99%（本地实验环境）
- 传感器读取成功率：> 98%
- 继电器控制成功率：> 99%
- 高风险误动作：0
- 平均响应时间：
  - 只读 skill < 3s
  - 控制 skill < 5s

---

## 9. 你当前最应该先做的 3 件事

1. 先把温湿度和继电器做成“语义化 MCP 工具”，减少模型直接拼 token。
2. 先落地“设备自检 skill + 环境快照 skill”，作为所有操作前置。
3. 给继电器控制加安全护栏（超时自动关闭、双确认、失败熔断）。

---

## 10. 最终建议

你的硬件和底层链路已经具备进入“实用阶段”的条件。下一步不是继续堆底层协议，而是把“工具能力”升级为“可控业务流程”：
- 用 MCP 保证原子能力可靠；
- 用 Skills 保证多步决策可解释、可追踪、可回滚；
- 用安全策略保证硬件不会被误控。

这套路线能让你从“能演示”走到“能长期跑”。
